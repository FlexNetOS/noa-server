#!/bin/bash

##############################################################################
# Claude Code Post-Task Hook
#
# Automatically triggers comprehensive audit after TodoWrite completion.
# This hook is called by Claude Code's hook system when a todo is marked
# as "completed".
#
# Environment Variables:
#   CLAUDE_TASK_ID          - Task ID that was completed
#   CLAUDE_TASK_DESCRIPTION - Task description
#   CLAUDE_WORKING_DIR      - Current working directory
#   CLAUDE_AUDIT_DISABLED   - Set to "true" to skip audit
#
# Exit Codes:
#   0  - Audit passed or skipped
#   1  - Audit failed
#   2  - Critical discrepancies
#   3  - Error during execution
#
# Author: Claude Flow Audit Team
# Version: 1.0.0
##############################################################################

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
CLAUDE_FLOW_ROOT="$CLAUDE_ROOT/claude-flow"

# Environment variables with defaults
TASK_ID="${CLAUDE_TASK_ID:-unknown-$(date +%s)}"
TASK_DESC="${CLAUDE_TASK_DESCRIPTION:-No description}"
WORKING_DIR="${CLAUDE_WORKING_DIR:-$(pwd)}"
AUDIT_DISABLED="${CLAUDE_AUDIT_DISABLED:-false}"

# Logging functions
log_info() {
    echo -e "${BLUE}[AUDIT HOOK]${NC} $*" >&2
}

log_success() {
    echo -e "${GREEN}[AUDIT HOOK]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[AUDIT HOOK]${NC} $*" >&2
}

# Check if audit is disabled
if [[ "$AUDIT_DISABLED" == "true" ]]; then
    log_info "Audit disabled via CLAUDE_AUDIT_DISABLED environment variable"
    exit 0
fi

# Check if config exists
CONFIG_FILE="$CLAUDE_ROOT/.claude/config.json"
if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "Config file not found: $CONFIG_FILE"
    exit 0  # Don't fail if config missing
fi

# Check if audit is enabled in config
AUDIT_ENABLED=$(jq -r '.audit.enabled // false' "$CONFIG_FILE")
if [[ "$AUDIT_ENABLED" != "true" ]]; then
    log_info "Audit disabled in config"
    exit 0
fi

# Log hook execution
log_info "========================================="
log_info "Post-Task Audit Hook Triggered"
log_info "========================================="
log_info "Task ID: $TASK_ID"
log_info "Task Description: $TASK_DESC"
log_info "Working Directory: $WORKING_DIR"
log_info ""

# Check if Node.js wrapper exists
WRAPPER_SCRIPT="$CLAUDE_FLOW_ROOT/hooks/post-task-audit-wrapper.js"
if [[ ! -f "$WRAPPER_SCRIPT" ]]; then
    log_error "Audit wrapper script not found: $WRAPPER_SCRIPT"
    log_error "Please run: npm run build in claude-flow/"
    exit 0  # Don't fail, just skip
fi

# Execute Node.js wrapper
log_info "Executing audit via Node.js wrapper..."
cd "$CLAUDE_FLOW_ROOT"

node "$WRAPPER_SCRIPT" \
    --task-id "$TASK_ID" \
    --target "$WORKING_DIR" \
    --description "$TASK_DESC" \
    --config "$CONFIG_FILE"

EXIT_CODE=$?

log_info ""
log_info "========================================="
if [[ $EXIT_CODE -eq 0 ]]; then
    log_success "✅ Audit completed successfully"
elif [[ $EXIT_CODE -eq 1 ]]; then
    log_error "❌ Audit failed: Confidence below threshold"
elif [[ $EXIT_CODE -eq 2 ]]; then
    log_error "❌ Audit failed: Critical discrepancies found"
else
    log_error "❌ Audit failed: Execution error"
fi
log_info "========================================="

exit $EXIT_CODE
