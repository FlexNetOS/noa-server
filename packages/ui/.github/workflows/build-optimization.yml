name: Build Optimization & Performance Monitoring

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/ui/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/ui/**'

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: packages/ui
        run: npm ci

      - name: Run type checking
        working-directory: packages/ui
        run: npm run typecheck

      - name: Run linting
        working-directory: packages/ui
        run: npm run lint

      - name: Build with bundle analysis
        working-directory: packages/ui
        run: npm run build:analyze
        env:
          VITE_DROP_CONSOLE: true
          VITE_COMPRESS_ASSETS: true

      - name: Check bundle size
        working-directory: packages/ui
        run: |
          BUNDLE_SIZE=$(du -sb dist | cut -f1)
          BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
          MAX_SIZE_KB=500

          echo "Bundle size: ${BUNDLE_SIZE_KB}KB"
          echo "Target: ${MAX_SIZE_KB}KB"

          if [ $BUNDLE_SIZE_KB -gt $MAX_SIZE_KB ]; then
            echo "‚ùå Bundle size ${BUNDLE_SIZE_KB}KB exceeds limit of ${MAX_SIZE_KB}KB"
            exit 1
          else
            echo "‚úÖ Bundle size is within limits"
          fi

      - name: Upload bundle visualization
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}
          path: packages/ui/docs/bundle-stats.html
          retention-days: 30

      - name: Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report-${{ github.sha }}
          path: |
            packages/ui/docs/bundle-report.json
            packages/ui/docs/bundle-report.txt
          retention-days: 30

      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportPath = path.join(
              process.cwd(),
              'packages/ui/docs/bundle-report.json'
            );

            if (!fs.existsSync(reportPath)) {
              console.log('Bundle report not found');
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const totalSizeKB = Math.round(report.totalGzipSize / 1024);
            const targetKB = 500;
            const percentage = Math.round((totalSizeKB / targetKB) * 100);
            const status = totalSizeKB <= targetKB ? '‚úÖ' : '‚ùå';

            const topChunks = report.chunks
              .slice(0, 5)
              .map(chunk => {
                const sizeKB = Math.round(chunk.gzipSize / 1024);
                const pct = chunk.percentage.toFixed(1);
                return `- ${chunk.file}: ${sizeKB}KB (${pct}%)`;
              })
              .join('\n');

            const body = `## ${status} Bundle Size Report

**Total Size**: ${totalSizeKB}KB / ${targetKB}KB gzipped (${percentage}% of budget)

**Top 5 Chunks**:
${topChunks}

**Warnings**: ${report.warnings.length}
**Recommendations**: ${report.recommendations.length}

${report.warnings.length > 0 ? '\n‚ö†Ô∏è **Warnings**:\n' + report.warnings.map(w => `- ${w}`).join('\n') : ''}

${report.recommendations.length > 0 ? '\nüí° **Recommendations**:\n' + report.recommendations.map(r => `- ${r}`).join('\n') : ''}

[View detailed visualization](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  lighthouse:
    runs-on: ubuntu-latest
    needs: build-and-analyze

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: packages/ui
        run: npm ci

      - name: Build application
        working-directory: packages/ui
        run: npm run build

      - name: Run Lighthouse CI
        working-directory: packages/ui
        run: |
          npm install -g @lhci/cli
          npm run preview &
          sleep 5
          lhci autorun || echo "Lighthouse CI failed but continuing"
          pkill -f "vite preview"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-${{ github.sha }}
          path: packages/ui/.lighthouseci/
          retention-days: 30

  performance-budget:
    runs-on: ubuntu-latest
    needs: build-and-analyze

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Download bundle report
        uses: actions/download-artifact@v4
        with:
          name: bundle-report-${{ github.sha }}
          path: packages/ui/docs/

      - name: Check performance budget
        working-directory: packages/ui
        run: |
          node -e "
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('docs/bundle-report.json'));
          const budget = JSON.parse(fs.readFileSync('scripts/performance-budget.json'));

          let failed = false;

          // Check total size budget
          const totalBudget = 500 * 1024; // 500KB
          if (report.totalGzipSize > totalBudget) {
            console.log('‚ùå Total bundle size exceeds budget');
            console.log(\`   Actual: \${Math.round(report.totalGzipSize / 1024)}KB\`);
            console.log(\`   Budget: \${Math.round(totalBudget / 1024)}KB\`);
            failed = true;
          }

          // Check individual chunk budgets
          const vendorBudget = 150 * 1024; // 150KB
          const routeBudget = 50 * 1024; // 50KB

          report.chunks.forEach(chunk => {
            if (chunk.file.includes('vendor') && chunk.gzipSize > vendorBudget) {
              console.log(\`‚ùå Vendor chunk '\${chunk.file}' exceeds budget\`);
              console.log(\`   Actual: \${Math.round(chunk.gzipSize / 1024)}KB\`);
              console.log(\`   Budget: \${Math.round(vendorBudget / 1024)}KB\`);
              failed = true;
            }
            if (chunk.file.includes('route') && chunk.gzipSize > routeBudget) {
              console.log(\`‚ùå Route chunk '\${chunk.file}' exceeds budget\`);
              console.log(\`   Actual: \${Math.round(chunk.gzipSize / 1024)}KB\`);
              console.log(\`   Budget: \${Math.round(routeBudget / 1024)}KB\`);
              failed = true;
            }
          });

          if (failed) {
            process.exit(1);
          } else {
            console.log('‚úÖ All performance budgets met');
          }
          "

  deployment:
    runs-on: ubuntu-latest
    needs: [build-and-analyze, lighthouse, performance-budget]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: packages/ui
        run: npm ci

      - name: Build for production
        working-directory: packages/ui
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_DROP_CONSOLE: true
          VITE_COMPRESS_ASSETS: true
          VITE_PWA_ENABLED: true

      - name: Deploy to Vercel/Netlify
        run: echo "Deploy step placeholder"
        # Add your deployment step here

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Bundle size within limits" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Lighthouse checks passed" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Performance budgets met" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY
