name: Self-Hosted Runner Tasks

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      runner_type:
        description: "Runner type to use"
        required: true
        default: "gpu"
        type: choice
        options:
          - gpu
          - docker
          - standard

jobs:
  gpu-accelerated-tasks:
    name: GPU Accelerated Tasks
    runs-on: [self-hosted, gpu]
    if: github.event.inputs.runner_type == 'gpu' || github.event.schedule == '0 2 * * *'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: GPU-accelerated testing
        run: |
          echo "Running GPU-accelerated tests"
          npm run test:unit -- --reporter=verbose

      - name: Performance benchmarks
        run: |
          echo "Running GPU-accelerated benchmarks"
          npm run perf:bench:system

  docker-containerized-builds:
    name: Docker Containerized Builds
    runs-on: [self-hosted, docker]
    if: github.event.inputs.runner_type == 'docker' || github.event.schedule == '0 2 * * *'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and test in container
        run: |
          docker build -t noa-server:test .
          docker run --rm noa-server:test npm run test:unit

      - name: Multi-platform build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: false
          tags: noa-server:multi-arch
          cache-from: type=gha
          cache-to: type=gha,mode=max

  heavy-computation:
    name: Heavy Computation Tasks
    runs-on: [self-hosted, heavy-compute]
    if: github.event.inputs.runner_type == 'standard' || github.event.schedule == '0 2 * * *'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Extended integration tests
        run: |
          echo "Running extended integration tests"
          npm run test:integration

      - name: Load testing
        run: |
          echo "Running load tests"
          npm run test:e2e

      - name: Comprehensive benchmarks
        run: |
          echo "Running comprehensive benchmarks"
          npm run perf:bench:all
