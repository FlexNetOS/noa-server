name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      target_version:
        description: 'Version to rollback to (leave empty for previous)'
        required: false
        type: string
      reason:
        description: 'Rollback reason'
        required: true
        type: string
      skip_backup:
        description: 'Skip backup of current state'
        required: false
        type: boolean
        default: false

env:
  KUBECONFIG_PATH: ~/.kube/config

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.detect.outputs.current_version }}
      target_version: ${{ steps.detect.outputs.target_version }}
      current_color: ${{ steps.detect.outputs.current_color }}
      previous_color: ${{ steps.detect.outputs.previous_color }}
      can_rollback: ${{ steps.validate.outputs.can_rollback }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Detect current state
        id: detect
        run: |
          # Get current active color
          CURRENT_COLOR=$(kubectl get service noa-service -n ${{ inputs.environment }} -o jsonpath='{.spec.selector.color}')
          echo "current_color=$CURRENT_COLOR" >> $GITHUB_OUTPUT

          # Determine previous color
          if [ "$CURRENT_COLOR" == "blue" ]; then
            echo "previous_color=green" >> $GITHUB_OUTPUT
          else
            echo "previous_color=blue" >> $GITHUB_OUTPUT
          fi

          # Get current version
          CURRENT_VERSION=$(kubectl get deployment noa-$CURRENT_COLOR -n ${{ inputs.environment }} -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get target version
          if [ -n "${{ inputs.target_version }}" ]; then
            echo "target_version=${{ inputs.target_version }}" >> $GITHUB_OUTPUT
          else
            # Get version from previous color deployment
            PREVIOUS_COLOR_VERSION=$(kubectl get deployment noa-$([ "$CURRENT_COLOR" == "blue" ] && echo "green" || echo "blue") \
              -n ${{ inputs.environment }} \
              -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2)
            echo "target_version=$PREVIOUS_COLOR_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Validate rollback
        id: validate
        run: |
          TARGET_VERSION="${{ steps.detect.outputs.target_version }}"
          CURRENT_VERSION="${{ steps.detect.outputs.current_version }}"

          # Check if target version exists
          if ! docker manifest inspect ghcr.io/${{ github.repository }}/api-gateway:$TARGET_VERSION > /dev/null 2>&1; then
            echo "ERROR: Target version $TARGET_VERSION does not exist"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if versions are different
          if [ "$TARGET_VERSION" == "$CURRENT_VERSION" ]; then
            echo "ERROR: Target version is the same as current version"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "can_rollback=true" >> $GITHUB_OUTPUT
          echo "âœ“ Rollback validation passed"
          echo "  Current: $CURRENT_VERSION"
          echo "  Target: $TARGET_VERSION"

      - name: Require approval for production
        if: inputs.environment == 'production'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ops-team,sre-team
          minimum-approvals: 2
          issue-title: 'Emergency Rollback Approval Required'
          issue-body: |
            **Environment:** ${{ inputs.environment }}
            **Current Version:** ${{ steps.detect.outputs.current_version }}
            **Target Version:** ${{ steps.detect.outputs.target_version }}
            **Reason:** ${{ inputs.reason }}

            Please review and approve this rollback request.

  backup-current:
    name: Backup Current State
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: needs.validate-rollback.outputs.can_rollback == 'true' && !inputs.skip_backup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Backup deployments
        run: |
          BACKUP_DIR="/tmp/rollback-backup-$(date +%s)"
          mkdir -p "$BACKUP_DIR"

          # Backup all Kubernetes resources
          kubectl get deployment,service,configmap,secret \
            -n ${{ inputs.environment }} \
            -o yaml > "$BACKUP_DIR/k8s-resources.yaml"

          # Backup current state metadata
          cat > "$BACKUP_DIR/metadata.json" << EOF
          {
            "backup_time": "$(date -Iseconds)",
            "environment": "${{ inputs.environment }}",
            "current_version": "${{ needs.validate-rollback.outputs.current_version }}",
            "current_color": "${{ needs.validate-rollback.outputs.current_color }}",
            "reason": "${{ inputs.reason }}",
            "triggered_by": "${{ github.actor }}"
          }
          EOF

          tar -czf /tmp/rollback-backup.tar.gz -C /tmp $(basename "$BACKUP_DIR")

      - name: Upload backup
        uses: actions/upload-artifact@v3
        with:
          name: rollback-backup-${{ needs.validate-rollback.outputs.current_version }}
          path: /tmp/rollback-backup.tar.gz
          retention-days: 30

  execute-rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [validate-rollback, backup-current]
    if: always() && needs.validate-rollback.outputs.can_rollback == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Scale up target deployment
        run: |
          TARGET_COLOR="${{ needs.validate-rollback.outputs.previous_color }}"

          # Ensure target deployment exists and has correct image
          kubectl set image deployment/noa-$TARGET_COLOR \
            noa-container=ghcr.io/${{ github.repository }}/api-gateway:${{ needs.validate-rollback.outputs.target_version }} \
            -n ${{ inputs.environment }}

          # Scale up target deployment
          kubectl scale deployment/noa-$TARGET_COLOR \
            --replicas=3 \
            -n ${{ inputs.environment }}

          # Wait for rollout
          kubectl rollout status deployment/noa-$TARGET_COLOR \
            -n ${{ inputs.environment }} \
            --timeout=5m

      - name: Switch traffic
        run: |
          TARGET_COLOR="${{ needs.validate-rollback.outputs.previous_color }}"

          # Switch service selector to target color
          kubectl patch service noa-service \
            -n ${{ inputs.environment }} \
            -p "{\"spec\":{\"selector\":{\"color\":\"$TARGET_COLOR\"}}}"

          echo "Traffic switched to $TARGET_COLOR (version ${{ needs.validate-rollback.outputs.target_version }})"

      - name: Verify health
        timeout-minutes: 3
        run: |
          # Wait for pods to be healthy
          kubectl wait --for=condition=ready pod \
            -l app=noa,color=${{ needs.validate-rollback.outputs.previous_color }} \
            -n ${{ inputs.environment }} \
            --timeout=180s

          # Run basic health checks
          for i in {1..10}; do
            kubectl run health-check-$i --image=curlimages/curl:latest \
              --restart=Never \
              --rm \
              -i \
              -n ${{ inputs.environment }} \
              -- curl -f http://noa-service:8080/health || exit 1
            sleep 2
          done

      - name: Scale down old deployment
        run: |
          CURRENT_COLOR="${{ needs.validate-rollback.outputs.current_color }}"

          # Scale down old deployment
          kubectl scale deployment/noa-$CURRENT_COLOR \
            --replicas=0 \
            -n ${{ inputs.environment }}

      - name: Record rollback
        run: |
          cat > /tmp/rollback-record.json << EOF
          {
            "rollback_time": "$(date -Iseconds)",
            "environment": "${{ inputs.environment }}",
            "from_version": "${{ needs.validate-rollback.outputs.current_version }}",
            "to_version": "${{ needs.validate-rollback.outputs.target_version }}",
            "from_color": "${{ needs.validate-rollback.outputs.current_color }}",
            "to_color": "${{ needs.validate-rollback.outputs.previous_color }}",
            "reason": "${{ inputs.reason }}",
            "triggered_by": "${{ github.actor }}"
          }
          EOF

          kubectl create configmap rollback-record-$(date +%s) \
            --from-file=/tmp/rollback-record.json \
            -n ${{ inputs.environment }}

  verify-rollback:
    name: Verify Rollback Success
    runs-on: ubuntu-latest
    needs: [validate-rollback, execute-rollback]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Run smoke tests
        run: |
          # Port-forward for testing
          kubectl port-forward -n ${{ inputs.environment }} \
            service/noa-service 8080:8080 &
          PF_PID=$!
          sleep 5

          # Run smoke tests
          bash ./scripts/release/smoke-tests.sh http://localhost:8080

          # Cleanup
          kill $PF_PID

      - name: Monitor metrics
        run: |
          echo "Monitoring post-rollback metrics..."
          for i in {1..12}; do
            echo "=== Check $i/12 ==="
            kubectl top pods -n ${{ inputs.environment }} -l color=${{ needs.validate-rollback.outputs.previous_color }}
            sleep 5
          done

      - name: Check error rates
        run: |
          ERROR_COUNT=$(kubectl logs -n ${{ inputs.environment }} \
            -l color=${{ needs.validate-rollback.outputs.previous_color }} \
            --tail=500 | grep -c "ERROR" || echo "0")

          echo "Error count in last 500 log lines: $ERROR_COUNT"

          if [ "$ERROR_COUNT" -gt 20 ]; then
            echo "WARNING: High error rate detected after rollback"
            exit 1
          fi

  notify:
    name: Notify Rollback
    runs-on: ubuntu-latest
    needs: [validate-rollback, execute-rollback, verify-rollback]
    if: always()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && ':white_check_mark:' || ':x:' }} Rollback ${{ job.status }} for ${{ inputs.environment }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Rollback ${{ job.status }}*\n\n*Environment:* ${{ inputs.environment }}\n*From:* ${{ needs.validate-rollback.outputs.current_version }}\n*To:* ${{ needs.validate-rollback.outputs.target_version }}\n*Reason:* ${{ inputs.reason }}\n*Triggered by:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create incident issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rollback Failed: ${{ inputs.environment }} to ${{ needs.validate-rollback.outputs.target_version }}`,
              body: `## Rollback Failure\n\n**Environment:** ${{ inputs.environment }}\n**Target Version:** ${{ needs.validate-rollback.outputs.target_version }}\n**Reason:** ${{ inputs.reason }}\n**Triggered by:** ${{ github.actor }}\n\n**Action Required:** Immediate investigation needed.`,
              labels: ['incident', 'rollback-failure', 'priority:critical']
            });
