apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: noa-system
  labels:
    app: haproxy
    component: load-balancer
data:
  haproxy.cfg: |
    #---------------------------------------------------------------------
    # Global settings
    #---------------------------------------------------------------------
    global
        log stdout format raw local0
        maxconn 50000
        daemon

        # SSL/TLS settings
        tune.ssl.default-dh-param 2048
        ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

        # Performance tuning
        tune.bufsize 32768
        tune.maxrewrite 8192
        nbproc 4
        cpu-map auto:1/1-4 0-3

    #---------------------------------------------------------------------
    # Default settings
    #---------------------------------------------------------------------
    defaults
        mode http
        log global
        option httplog
        option dontlognull
        option http-server-close
        option forwardfor except 127.0.0.0/8
        option redispatch

        # Timeouts
        timeout connect 5s
        timeout client 60s
        timeout server 60s
        timeout tunnel 3600s
        timeout http-keep-alive 10s
        timeout http-request 10s
        timeout queue 30s

        # Error handling
        retries 3
        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http

    #---------------------------------------------------------------------
    # Stats interface
    #---------------------------------------------------------------------
    listen stats
        bind *:8404
        mode http
        stats enable
        stats uri /stats
        stats refresh 10s
        stats show-legends
        stats show-node
        stats auth admin:admin123
        stats admin if TRUE

    #---------------------------------------------------------------------
    # Frontend - HTTP
    #---------------------------------------------------------------------
    frontend http_frontend
        bind *:80
        mode http

        # Redirect to HTTPS
        redirect scheme https code 301 if !{ ssl_fc }

        # ACLs for routing
        acl is_api hdr(host) -i api.noa-server.io
        acl is_mcp hdr(host) -i mcp.noa-server.io
        acl is_ws path_beg /ws

        # Rate limiting
        stick-table type ip size 1m expire 10s store http_req_rate(10s)
        http-request track-sc0 src
        http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

        # Use backends based on ACLs
        use_backend api_backend if is_api
        use_backend mcp_backend if is_mcp
        use_backend websocket_backend if is_ws
        default_backend web_backend

    #---------------------------------------------------------------------
    # Frontend - HTTPS
    #---------------------------------------------------------------------
    frontend https_frontend
        bind *:443 ssl crt /etc/haproxy/certs/noa-server.pem alpn h2,http/1.1
        mode http

        # Security headers
        http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        http-response set-header X-Frame-Options "DENY"
        http-response set-header X-Content-Type-Options "nosniff"
        http-response set-header X-XSS-Protection "1; mode=block"

        # ACLs for routing
        acl is_api hdr(host) -i api.noa-server.io
        acl is_mcp hdr(host) -i mcp.noa-server.io
        acl is_ws path_beg /ws
        acl is_health path /health

        # Health checks
        use_backend health_backend if is_health

        # Rate limiting
        stick-table type ip size 1m expire 10s store http_req_rate(10s)
        http-request track-sc0 src
        http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

        # Use backends based on ACLs
        use_backend api_backend if is_api
        use_backend mcp_backend if is_mcp
        use_backend websocket_backend if is_ws
        default_backend web_backend

    #---------------------------------------------------------------------
    # Backend - Web application (with load balancing)
    #---------------------------------------------------------------------
    backend web_backend
        mode http
        balance roundrobin

        # Sticky sessions
        cookie SERVERID insert indirect nocache

        # Health checks
        option httpchk GET /health
        http-check expect status 200

        # Server options
        default-server inter 3s fall 3 rise 2

        # Compression
        compression algo gzip
        compression type text/html text/plain text/css application/json application/javascript

        # Servers (dynamic from Kubernetes service)
        server-template noa-server 20 noa-server.noa-system.svc.cluster.local:3000 check resolvers k8s init-addr none cookie s1

    #---------------------------------------------------------------------
    # Backend - API (round-robin with health checks)
    #---------------------------------------------------------------------
    backend api_backend
        mode http
        balance roundrobin

        # Health checks
        option httpchk GET /api/v1/health
        http-check expect status 200

        # Rate limiting per user
        stick-table type string len 64 size 1m expire 10s store http_req_rate(10s)
        http-request track-sc1 req.hdr(Authorization)
        http-request deny deny_status 429 if { sc_http_req_rate(1) gt 200 }

        # Servers
        server-template api-server 20 noa-server.noa-system.svc.cluster.local:3000 check resolvers k8s init-addr none

    #---------------------------------------------------------------------
    # Backend - MCP (least connections for long-running tasks)
    #---------------------------------------------------------------------
    backend mcp_backend
        mode http
        balance leastconn

        # Health checks
        option httpchk GET /health
        http-check expect status 200

        # Long timeout for MCP operations
        timeout server 300s

        # Servers
        server-template mcp-server 10 mcp-server.noa-system.svc.cluster.local:8080 check resolvers k8s init-addr none

    #---------------------------------------------------------------------
    # Backend - WebSocket (source IP hash for persistence)
    #---------------------------------------------------------------------
    backend websocket_backend
        mode http
        balance source
        hash-type consistent

        # WebSocket specific options
        option forwardfor
        option http-server-close
        timeout tunnel 3600s
        timeout server 3600s

        # Servers
        server-template ws-server 20 noa-server-websocket.noa-system.svc.cluster.local:8080 check resolvers k8s init-addr none

    #---------------------------------------------------------------------
    # Backend - Health checks
    #---------------------------------------------------------------------
    backend health_backend
        mode http
        http-request return status 200 content-type text/plain string "OK\n"

    #---------------------------------------------------------------------
    # DNS resolvers for Kubernetes
    #---------------------------------------------------------------------
    resolvers k8s
        nameserver dns1 kube-dns.kube-system.svc.cluster.local:53
        resolve_retries 3
        timeout resolve 1s
        timeout retry 1s
        hold other 30s
        hold refused 30s
        hold nx 30s
        hold timeout 30s
        hold valid 10s
        hold obsolete 30s

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: haproxy
  namespace: noa-system
  labels:
    app: haproxy
    component: load-balancer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: haproxy
  template:
    metadata:
      labels:
        app: haproxy
    spec:
      containers:
        - name: haproxy
          image: haproxy:2.9-alpine
          ports:
            - name: http
              containerPort: 80
            - name: https
              containerPort: 443
            - name: stats
              containerPort: 8404
          volumeMounts:
            - name: config
              mountPath: /usr/local/etc/haproxy
            - name: certs
              mountPath: /etc/haproxy/certs
          livenessProbe:
            httpGet:
              path: /stats
              port: 8404
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /stats
              port: 8404
            initialDelaySeconds: 10
            periodSeconds: 5
          resources:
            requests:
              cpu: 500m
              memory: 256Mi
            limits:
              cpu: 2000m
              memory: 1Gi
      volumes:
        - name: config
          configMap:
            name: haproxy-config
        - name: certs
          secret:
            secretName: haproxy-tls

---
apiVersion: v1
kind: Service
metadata:
  name: haproxy
  namespace: noa-system
  labels:
    app: haproxy
spec:
  type: LoadBalancer
  ports:
    - name: http
      port: 80
      targetPort: 80
    - name: https
      port: 443
      targetPort: 443
    - name: stats
      port: 8404
      targetPort: 8404
  selector:
    app: haproxy
